---
title: "21. Analysis"
author: "Christina Raw"
date: "23/3/2022"
output: html_document
---

In this script I am going to analyse how biodiversity responds to different agricultural practices. 
The data set consists of measures of biodiversity under different agricultural systems and crops.

## Model components:

x: continuous, biodiversity quantitative measure 
y: categorical, agricultural system. Factor with 8 levels: conservation, conventional, ipm, mixed, organic, traditional, transgenic and unclassified. 

The response of biodiversity to agriculture varies across taxonomic and functional groups and is mediated by a wide array of variables, such as geographical location, spatial scale, level of intensification or proximity to natural habitat, to name a few. Therefore, I would like to input the following variables as random effects to see how much of the variance is explained by them: geographical location, taxon and functional group. (no info for functional or geographical location)

To study whether biodiversity responds differently depending on the specific practices applied , I would also like to include the following variables as random effects: cover crop type, bt type, application of fertilizers/pesticides/herbicides. (not enoigh data to test this for now)

To control for differential sampling methods, I would like to include sampling method as random effect. (no data pm this)

Also, given the nest structure of the data, I want to include Paper_ID as random effect to control for the structure.

So, random effects I can actually test: paper id, taxon and crop type.

## Model limitations

As often happens in ecology, my data set is very heterogeneous. Since I am looking at biodiversity response and agricultural systems in general, I have many different types of biodiversity data that cover biomass, efficiency, diversity, development, enzymatic activity, reproduction and survival. I also have data for a wide range of agricultural systems.

The data heterogeneity leads to small sample size per data type, limiting the number of variables I can input in the model leading to an over fit model. There is a general consensus of 10 observation per term included in the model, and I simply do not have enough data to confidently test the relationship between biodiversity and agricultural systems, let alone test how variance is explained by the random effects. 

## Approaches

1. Collapsing categories

Collapsing agricultural system categories to increase the sample size for each level does not make sense in this case, as the goal of this project is to assess how the different agricultural practices affect biodiversity.

1. From maximal to simplified model 

I cannot follow this approach as I do not have enough data to generate a maximal model

2. From simplified model to (if needed) a more complex model

I am going to test the random effects one by one and check the goodness of fit of each model. Once I know which variables are relevant, I will build a maximal model and test its goodness of fit. However, I will not be able to trust the maximal model output as I do not have enough data.


```{r, results = 'hide'}

library(readxl) # To read excel files
library(here) # To fetch files 
library(lme4) # To run more complex linear models
library(dplyr) # To handle data
library(lmtest)
library(knitr)

```

```{r}

d <- read_xlsx(here("Datasets", "05.Excel_Dataset_to_model.xlsx")) # Load data

# Factorize the categorical variables I will use in the model.

str(d)
unique(d$biodiveristy_metric_category)
d$agricultural_system <- as.factor(d$agricultural_system)
d$Crop <- as.factor(d$Crop)
d$magpie_class <- as.factor(d$magpie_class)
d$Phylum <- as.factor(d$Phylum)
str(d)


unique(d$Crop) # Change Bt_CropName into just CropName

d$Crop[d$Crop == "Bt_Cotton"]<- "Cotton"
d$Crop[d$Crop == "Bt_Sunflower"]<- "Sunflower"
d$Crop[d$Crop == "Bt_Potato"]<- "Potato"
d$Crop[d$Crop == "Bt_Rape"]<- "Rape_seed"
d$Crop[d$Crop == "Bt_Maize"]<- "Maize"
d$Crop[d$Crop == "Bt_Rice"]<- "Rice"
d$Crop[d$Crop == "GM_Rape"]<- "Rape_seed"
d$Crop[d$Crop == "Bt_Corn"]<- "Corn"
d$Crop[d$Crop == "Bt_Broccoli"]<- "Broccoli"
d$Crop[d$Crop == "GM_Potato"]<- "Potato"
d$Crop[d$Crop == "GM_Cotton"]<- "Cotton"
d$Crop[d$Crop == "GM_Tomato"]<- "Tomato"
d$Crop[d$Crop == "Gm_Strawberry"]<- "Strawberry"

unique(d$biodiveristy_metric_category) # Subset diversity data
diversity <- subset(d, d$biodiveristy_metric_category == "diversity")

```

# Model

## Basic lm model

```{r}

# Basic y - x relationship

m0 <- lm(Intervention_Percentage_Change ~ agricultural_system, data = diversity)
plot(m0)

```

Residuals vs. fitted not great and Q-Q plot indicates another distribution model could potentially fit better... However, I'm going to keep exploring this line of thought.

### Tukey test

```{r}

m0.aov <- aov(m0)
tukey.test <- TukeyHSD(m0.aov)
tukey.test

```

## Test random effects

```{r}

# Test random effects and assess goodness of fit

m1 <- lmer(Intervention_Percentage_Change ~ agricultural_system + (1|Paper_ID), data = diversity)
summary(m1) # Paper ID takes up a lot of the variance, probably because as the papers are syntheses, they probaly report data on many different species. So, does including paper_ID as random effect make sense?

m2 <- lmer(Intervention_Percentage_Change ~ agricultural_system + (1|Crop), data = diversity)
summary(m2)  # Crop explains 25 % of the variance

m3 <- lmer(Intervention_Percentage_Change ~ agricultural_system + (1|Phylum), data = diversity)
summary(m3) # Phylum explains even more than crop (36%)

```

It seems as the three random effects explains some variance, but does including them improve the model fit?

### Likelihood ratio tests

```{r}

m1 <- lmer(Intervention_Percentage_Change ~ agricultural_system + (1|Paper_ID), data = diversity)
m2 <- lmer(Intervention_Percentage_Change ~ agricultural_system + (1|Paper_ID) + (1|Crop), data = diversity)

```
This error occurs when the variance of a random effect is 0 or when the correlation between fixed effects is = - 1. In this case, the variance for the Crop random effect is causing this error. This can be due to a case of over fitting of the model, which can be caused for there not being enough data get all the estimates for the more complex model. Therefore, I cannot test whether includin the random effects improves or not the model. 

```{r}

m1 <- lmer(Intervention_Percentage_Change ~ agricultural_system + (1|Paper_ID), data = diversity)
m2 <- lmer(Intervention_Percentage_Change ~ agricultural_system + (1|Paper_ID) + (1|Phylum), data = diversity)

lrtest(m1, m2)
```
In this case there is enough data do get the estimates but there is an error caused due to NAs in rows, which means the modes are based on different data sets.

# Wait, I can't mix all the data together, because they have different distributions

My data set contains data for diversity, biomass, development, efficiency, enzymatic activity, reproduction and survival. As they are different types of data with different distributions, I have to apply a model to each data type that suits its distribution. 

Since they are different types of data, I am splitting them into separate data frames.

```{r}

metric <- unique(d$biodiveristy_metric_category)

metric_list <- list() 

for (mt in metric){
  data <- dplyr :: filter( d , biodiveristy_metric_category == mt)
  metric_list[[mt]] <- data
}

list2env( metric_list, envir = .GlobalEnv) # Make a data frame for each crop
```
 
## Diversity data
 
### What is the data ditribution?

Within the diversity data set I have data with different distributions. In the diversity data set, I have the following data types: 

```{r, echo = FALSE}

kable(table(diversity$Biodiversity_measure))

```

For example, abundance has a poisson distribution, whereas species richness can have a normal distribution. Therfore, I have to apply different models to each type of data.

### Abundance N = 64

Normally abundance data has a Poisson distribution. But, because this abundance data comes from transforming the percentages, I don't think it can be considered count data and have a poisson distribution. Actually, what distribution does the data have? 

```{r}
abundance <- subset(diversity, Biodiversity_measure == "Abundance") # Make abundance data set
hist(abundance$abundance)
```
However, this does not look like a poisson distribution. I'm not sure.... I am going to try out the glmm. 

```{r}
abundance$abundane <-  round(abundance$Intervention_Percentage_Change, digits = 0) # Because poisson is integer

g0 <- glm(abundance ~ agricultural_system, family = "poisson", data = abundance)
summary(g0)

```

Very strange values and very over dispersed...not good.

I'm going to do a linear model instead of a generalised linear model, as this is not the typical abundance data with poisson distribution.

```{r}

# Basic lm model: relationship abundance ~ agricultural system

m1 <- lm(Intervention_Percentage_Change ~ agricultural_system, data = abundance)
summary(m1)
plot(m1)
```

R2 = 0.016 and bad diagnostic plots. Residuals vs fitted do not have a normal distribution. The Q-Q plot the data distribution has extreme tails, which we know from the histogram. Given these results, I don't think lm is a good approach.

This brings me to the next question. What is the distribution of the data? Since the data comes from transforming percentage data...

# But wait, all the data comes from transfomring a percentage chanfe so...in this case all the data IS the same?

Generally, biodiversity data can show different distributions. However, in this case, since the data comes from transforming percentage change into absolute values, I am not really sure what the data distribution is.

```{r}
hist(diversity$Intervention_Percentage_Change)

```

It does look like a poisson distribution. Let's try a glm on the whole diversity dataset.

```{r}

diversity$abundance <- round(diversity$Intervention_Percentage_Change, digits = 0) # Because poisson is integer

g0 <- glm(abundance ~ agricultural_system, family = "poisson", data = diversity)
summary(g0)

```

Very over dispersed, not good. 

# Conclusions...

  - What is the data type and distribution?
  - Need more data



