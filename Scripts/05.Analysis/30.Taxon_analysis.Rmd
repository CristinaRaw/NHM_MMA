---
title: "30.Taxon_analysis"
author: "Christina Raw"
date: "11/5/2022"
output: html_document
---

Research supports that the response of biodiversity to agricultural systems can vary depending on the functional group. For example, natural enemies can decrease while pests can increase. Therefore, I am going to test the moderating effect of functional group on the response of biodiversity to agricultural systems. However, since I do not have all the functional group data in the data set (for now), but I do have data to taxon level, I am going to use taxon as proxy of functional group. 

Also, since I already know there is influential data, I am going to directly do the model with the robust package.

```{r, warning = FALSE, message = FALSE}

library(blme) # For Bayesian analysis
library(readxl) # For reading the excel data set
library(here) # For specifying file paths
library(knitr) # For making tables
library(kableExtra)# for pretty rmd tables
library(dplyr) # For some data wrangling
library(tidyr) # For some data wrangling
library(ggplot2) # For making cool plots
library(MuMIn) # For model selection
```

## 1. Take a look at the data

```{r, include = FALSE}

d <- read_excel(here("Datasets", "07.Excel_Dataset_to_model_LRR_LONG.xlsx"))

str(d)
d$Crop <- as.factor(d$Crop)
d$Treatment <- as.factor(d$Treatment)
d$magpie_class <- as.factor(d$magpie_class)
d$Weight <- as.numeric(d$Weight)
d$biodiveristy_metric_category <- as.factor(d$biodiveristy_metric_category)

```

## Data per kingdom

```{r, echo = FALSE}
kingdom <- as.data.frame(table(d$Kingdom))
colnames(kingdom) <- c("Treatment", "N_Observations")
kingdom <- kingdom[order(kingdom$N_Observations, decreasing = TRUE),]

kbl(kingdom, row.names = FALSE)
```

Kingdom is not really informative, so I will do it by phylum

## Data per taxon

```{r, echo = FALSE}
# Data per taxon

Phylum <- as.data.frame(table(d$Phylum))
colnames(Phylum) <- c("Treatment", "N_Observations")
Phylum <- Phylum[order(Phylum$N_Observations, decreasing = TRUE),]

kbl(Phylum, row.names = FALSE)

```

## Curate phylum names and collapse categories

```{r}
d$Phylum[d$Phylum == "Chordata"] <- "Vertebrates"
d$Phylum[d$Phylum == "Insecta"] <- "Arthropoda"
d$Phylum[d$Phylum == "Azotobacter"] <- "Microbes"
d$Phylum[d$Phylum == "Microbial_community"] <- "Microbes"
d$Phylum[d$Phylum == "Microbiall_community"] <- "Microbes"
d$Phylum[d$Phylum == "Proteobacteria"] <- "Microbes"
d$Phylum[d$Phylum == "Rhizosphere_actinobacteria"] <- "Rhizosphere_bacteria"
d$Phylum[d$Phylum == "Rhizosphere_Fungal_community"] <- "Rhizosphere_fungi"
d$Phylum[d$Phylum == "Rhizosphere_Fungal_population"] <- "Rhizosphere_fungi"
d$Phylum[d$Phylum == "Rhyzosphere_microbes"] <- "Rhizosphere_bacteria"
d$Phylum[d$Phylum == "Weeds"] <- "Weed"


Phylum <- as.data.frame(table(d$Phylum))
colnames(Phylum) <- c("Treatment", "N_Observations")
Phylum <- Phylum[order(Phylum$N_Observations, decreasing = TRUE),]

kbl(Phylum, row.names = FALSE)


```

## Analysis

```{r}
m3 <- blmer(LRR ~ Treatment*Phylum + (1|ID), weights = Weight, data = d, control = lmerControl(optimizer ="Nelder_Mead"), na.action = "na.omit")

summary(m3)
```

## Arthropods only

```{r}

bugs <- subset(d, d$Phylum == "Arthropoda" &
                 (d$agricultural_system == "Conventional" | 
                    d$agricultural_system == "Transgenic"))

table(bugs$agricultural_system)

model_bugs <- blmer(LRR ~ Treatment + (1|ID), weights = Weight, data = bugs, control = lmerControl(optimizer ="Nelder_Mead"), na.action = "na.omit")

summary(model_bugs)
```

```

