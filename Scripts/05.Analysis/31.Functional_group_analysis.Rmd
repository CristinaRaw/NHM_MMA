---
title: "31.Functional_group_analysis"
author: "Christina Raw"
date: "24/5/2022"
output: html_document
---

In this script I am going to analyse how biodiversity responds to agricultural systems but taking a closer look at what is happening at the functional group level. 

Steps:

1. Subset the data by functional group
2. Within each functional group data frame, subset the treatment levels that have more than 10 observations.
3. Model

## 1. Subset the data by funtional group

### 1.1. Load and prepare data frame

```{r}

rm(list=ls())

library(readxl)
library(here)
library(robustlmm)
library(blme)

d <- read_excel(here("Datasets", "07.Excel_Dataset_to_model_LRR_LONG.xlsx"))

d$Treatment <- as.factor(d$Treatment)
d$Functional_group <- as.factor(d$Functional_group)
d$ID <- as.factor(d$ID)
d$Crop <- as.factor(d$Crop)

# Collapse organic and sustainable

d$Treatment[d$Treatment == "Organic"] <- "Sustainable"

# Include monoculture in conventional 

d$Treatment[d$Treatment == "Monoculture"] <- "Conventional"

# Make conventional the treatment reference level

d$Treatment <- relevel(d$Treatment, ref = "Conventional")

```

### 1.2. Subset data by functional group

```{r}

unique(d$Functional_group)

group <- unique(d$Functional_group)

group_list <- list() 

for (i in group){
data <- dplyr :: filter( d , Functional_group == i)
group_list[[i]] <- data
}

list2env(lapply(group_list, as.data.frame), .GlobalEnv)

```

## 2. Within each functional group data frame, subset the treatment levels that have more than 10 observations.

Now that I have a separate data frame for each functional group, I will subset the agricultural systems that have more than ten observations for that functional group. 

### a. Air Climate Freshwater Soil and Extreme events

This functional group is basically represented by plants. Heads up, the following code might be annoying due to group's super long name.

```{r}
table(Air_Climate_Freshwater_Soil_ExtremeEvents$Treatment)

treatment_obs <- as.data.frame(table(Air_Climate_Freshwater_Soil_ExtremeEvents$Treatment))
colnames(treatment_obs) <- c("Treatment", "N_Observations")
treatment_obs <- treatment_obs[order(treatment_obs$N_Observations, decreasing = TRUE),]

treatment_obs <- subset(treatment_obs, treatment_obs$N_Observations >= 10)

Air_Climate_Freshwater_Soil_ExtremeEvents <- Air_Climate_Freshwater_Soil_ExtremeEvents[Air_Climate_Freshwater_Soil_ExtremeEvents$Treatment %in% treatment_obs$Treatment, ]
```

### b. Borer

```{r}
# Borer

table(Borer$Treatment)

```
This functional group does not have any agricultural treatment whith more than 10 observations, so I will skip it. 

### c. Natrual_enemies

```{r}
table(Natural_enemy$Treatment)

treatment_obs <- as.data.frame(table(Natural_enemy$Treatment))
colnames(treatment_obs) <- c("Treatment", "N_Observations")
treatment_obs <- treatment_obs[order(treatment_obs$N_Observations, decreasing = TRUE),]

treatment_obs <- subset(treatment_obs, treatment_obs$N_Observations >= 10)

Natural_enemy <- Natural_enemy[Natural_enemy$Treatment %in% treatment_obs$Treatment, ]
```

### d. Pest

```{r}
table(Pest$Treatment)

treatment_obs <- as.data.frame(table(Pest$Treatment))
colnames(treatment_obs) <- c("Treatment", "N_Observations")
treatment_obs <- treatment_obs[order(treatment_obs$N_Observations, decreasing = TRUE),]

treatment_obs <- subset(treatment_obs, treatment_obs$N_Observations >= 10)

Pest <- Pest[Pest$Treatment %in% treatment_obs$Treatment, ]

```


### e. Pollination and seed dispersal

```{r}
table(Pollination_seeds$Treatment)
```

This functional group does not have any agricultural treatment whith more than 10 observations, so I will skip it. 

### f. Predators 

```{r}

table(Predators$Treatment)

treatment_obs <- as.data.frame(table(Predators$Treatment))
colnames(treatment_obs) <- c("Treatment", "N_Observations")
treatment_obs <- treatment_obs[order(treatment_obs$N_Observations, decreasing = TRUE),]

treatment_obs <- subset(treatment_obs, treatment_obs$N_Observations >= 10)

Predators <- Predators[Predators$Treatment %in% treatment_obs$Treatment, ]

```


### g. Soil

```{r}
table(Soil$Treatment)

treatment_obs <- as.data.frame(table(Soil$Treatment))
colnames(treatment_obs) <- c("Treatment", "N_Observations")
treatment_obs <- treatment_obs[order(treatment_obs$N_Observations, decreasing = TRUE),]

treatment_obs <- subset(treatment_obs, treatment_obs$N_Observations >= 10)

Soil <- Soil[Soil$Treatment %in% treatment_obs$Treatment, ]
```


### h. Soil and pollination

Not enough observations

## 2. Alaysis

### a. Air climate Freshwater Soil Extreme Events (plants)

```{r}

plant_model <- blmer(LRR ~ Treatment + (1|ID) + (1|Crop), 
                     control = lmerControl(optimizer ="Nelder_Mead"), 
                     data = Air_Climate_Freshwater_Soil_ExtremeEvents)

summary(plant_model)

```

### b. Natural enemies 

```{r}

enemy_model <- blmer(LRR ~ Treatment + (1|ID) + (1|Crop), 
                     control = lmerControl(optimizer ="Nelder_Mead"), 
                     data = Natural_enemy)


```
### c. Pest 

```{r}

pest_model <- blmer(LRR ~ Treatment + (1|ID) + (1|Crop), 
                    control = lmerControl(optimizer ="Nelder_Mead"), 
                    data = Pest)

summary(pest_model)

```

### d. Predator 

```{r}

predator_model <- blmer(LRR ~ Treatment + (1|ID) + (1|Crop), 
                        control = lmerControl(optimizer ="Nelder_Mead"), 
                        data = Predators)

summary(predator_model)

```

### e. Soil 

```{r}

soil_model <- blmer(LRR ~ Treatment + (1|ID) + (1|Crop), 
                        control = lmerControl(optimizer ="Nelder_Mead"), 
                        data = Soil)

summary(soil_model)

```

